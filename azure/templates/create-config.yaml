jobs:
  - deployment: Deploy
    displayName: Create/update K8s configuration resources
    environment: $(kubernetesEnvironment)
    strategy:
      runOnce:
        deploy:
          steps:
            - checkout: self

            - task: Kubernetes@1
              displayName: Delete configmap
              inputs:
                namespace: $(kubernetesNamespace)
                command: delete
                arguments: configmap giga-trino-configmap --ignore-not-found

            - task: Kubernetes@1
              displayName: Create secret
              inputs:
                namespace: $(kubernetesNamespace)
                configurationType: inline
                command: apply
                useConfigurationFile: true
                inline: |
                  apiVersion: v1
                  kind: Secret
                  metadata:
                    name: "giga-trino-secrets-$(deployEnv)"
                    labels:
                      app.kubernetes.io/name: giga-trino
                      app.kubernetes.io/part-of: giga-dataops-platform
                      app.kubernetes.io/component: trino
                  stringData:
                    password.db: |-
                      $(adminAuth)
                      $(adminAuthGigaTrino)
                      $(adminAuthGigaSuperset)
                      $(adminAuthGigaDataIngestion)
                    group.db: |-
                      admin:giga-admin,tmadmin
                      giga-trino:giga-trino
                      giga-superset:giga-superset
                    AZURE_STORAGE_ACCESS_KEY: "$(storageAccessKey)"
                    AZURE_STORAGE_ACCOUNT_NAME: "$(storageAccountName)"
                    HIVE_METASTORE_URI: "hive-metastore.ictd-ooi-dagster-$(deployEnv).svc.cluster.local"
